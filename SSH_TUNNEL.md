# 使用 SSH 隧道访问本地服务

这个仓库的 `install.sh` 只部署 VLESS/HY2，并不会在 VPS 上额外开启 SOCKS5 端口；建议使用本地 ↔ VPS 的 SSH 隧道把远程服务转发到 `127.0.0.1`，再让浏览器或系统代理通过这个本地端口访问，从而避免任何公网 SOCKS5 暴露。

## 1. 前提条件

- 本地和 VPS 上都已安装 OpenSSH（`ssh`/`sshd`），VPS 端允许你用公钥或密码登录。
- VPS 上的 `sshd_config` 默认允许本地端口转发；若启用了 `restrict` 或 `permitopen`，请确认设置允许你需要的目标地址/端口。
- 本地机器可以访问 127.0.0.1 XXX 端口（例如 1080），并不会被其他服务占用。

## 2. 典型流程（以 HY2 UDP 8443 为例）

1. 先在 VPS 上确认 HY2 正在监听的端口（默认 `HY2_PORT=8443`），并且该端口已经放行（Cloudflare DNS only + 防火墙允许）。
2. 在本地执行 SSH 隧道命令，把远程服务映射到本地：  
   ```bash
   ssh -N -L 127.0.0.1:1080:127.0.0.1:8443 user@vps.example.com
   ```  
   - `-N` 表示不执行远程命令，只建隧道；  
   - `-L 本地地址:本地端口:远程地址:远程端口` 可自由替换本地端口（不一定要 1080），比如 `127.0.0.1:1090:127.0.0.1:8443`；  
   - `user@vps.example.com` 用你的 VPS 登录账号。
3. 在本地浏览器/系统代理中配置 SOCKS5 代理 `127.0.0.1:1080`，所有流量都会通过 SSH 隧道被转发到 VPS 上的 HY2 服务。需要访问 VLESS/TCP 可把目标改为 `127.0.0.1:443`。

## 3. 进阶提示

- 如果 `sshd_config` 中启用了 `restrict`，请在 `authorized_keys` 里添加 `permitopen` 限制，如 `permitopen="127.0.0.1:8443"`，防止 key 被滥用时访问其它端口。  
- 当需要多个隧道时，可以为每个本地端口再开一个 `-L` 参数，或使用 `ssh -N -L 127.0.0.1:1080:127.0.0.1:8443 -L 127.0.0.1:1090:127.0.0.1:443 ...`。  
- 本地端口不用开在外网、也不要放到 `0.0.0.0`，这样防火墙无需为隧道打开额外端口；只需让本地目标应用连 `127.0.0.1:<端口>` 即可。若必须在 LAN 公开，可把本地地址换成 `0.0.0.0`，但需额外做好访问控制。

## 4. 常见问题

- **要避免 `Unable to allocate port 1080`？**：说明本地端口已被占用，换一个未使用端口（例如 1081）即可。  
- **为什么要用 `127.0.0.1` 而不是 VPS 地址？**：SSH 只会在本地打开监听，安全性更高，不会在 VPS 的公网接口再启新端口。  
- **是否需要在 VPS 上打开新的防火墙端口？**：只需要保留 HY2/VLESS 原本的端口（如 443/8443）；SSH 隧道在本地 `127.0.0.1` 运行，不需要改 VPS 安全组。

## 5. 恢复连接

如果 SSH 隧道断开，只需重新运行上面的 `ssh -N -L …` 命令；也可以用 `autossh` 或 `systemd` 单元让隧道自动重建。
